<!DOCTYPE html>

<html>

<head>
	<title> Graphene-${projectName}-Web ${version}</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- CSS -->
	<!-- MFM COMMENTED OUT <link type="text/css" href="resources/css/cssjit/base.css" rel="stylesheet" /> -->
	<!-- <link type="text/css" href="core/resources/css/cssjit/ForceDirected.css" rel="stylesheet" /> -->
	<link type="text/css" href="core/js/libs/extjs/resources/css/ext-all-gray.css"  rel="stylesheet"  />
	<link type="text/css" href="core/js/libs/extjs/ux/css/CheckHeader.css"  rel="stylesheet"  />

    <style type="text/css">
		x-grid-cell-first {
			overflow: hidden;
			-o-text-overflow: ellipsis;
			text-overflow: ellipsis;
			padding: 2px 6px 3px;
			white-space: nowrap; 
		}
		
		#EntityGraph {
			background-color: lightyellow;
			color: 'black';
		}
		
		#TransfersGraph {
			background-color: lightyellow;
			color: 'black';
		}
		
		x-busy-tab {
			background-color: lightyellow;
		}
		
		x-hasdata-tab {
			background-color: red;
			color: white;
		}
		
		x-nodata-tab {
			background-color: lightblue;
		}
		
		.groupcolor0 .account{
			color:black;
		}
		
		.groupcolor1  .account{
			color: red;
		}
		
		.groupcolor2  .account{
			color: blue;
		}
		
		.groupcolor3  .account{
			color: green;
		}
		
		.groupcolor4  .account{
			color: orange;
		}
		
		.bars rect {
			fill: steelblue;
		}
		
		.axis text {
			font: 10px sans-serif;
		}
		
		.axis path, .axis line {
			fill: none;
			stroke: #000;
			shape-rendering: crispEdges;
		}
		 
		.grid .tick {
			stroke: lightgrey;
			stroke-opacity: 0.75;
		}

		.grid_default_btn {
			background-position: center center;
			background-image: url(core/images/grid_icon.png) !important;
		}

		.hierarch_circle_btn {
			background-position: center center;
			background-image : url(core/images/hierarchy_circle_icon.png) !important;
		}

		.hierarch_default_btn {
			background-position: center center;
			background-image : url(core/images/hierarchy_icon.png) !important;
		}

		.cose_anim_btn {
			background-position: center center;
			background-image : url(core/images/cose_animated_icon.png) !important;
		}

		.cose_unanim_btn {
			background-position: center center;
			background-image : url(core/images/cose_icon.png) !important;
		}

		.arbor_anim_btn {
			background-position: center center;
			background-image : url(core/images/arbor_animated_icon.png) !important;
		}

		.arbor_unanim_btn {
			background-position: center center;
			background-image : url(core/images/arbor_icon.png) !important;
		}

		.arbor_wheel_anim_btn {
			background-position: center center;
			background-image : url(core/images/arbor_wheel_animated_icon.png) !important;
		}

		.arbor_wheel_unanim_btn {
			background-position: center center;
			background-image : url(core/images/arbor_wheel_icon.png) !important;
		}
		
		.toolbar_help_btn {
			background-position: center center;
			background-image : url(core/images/HelpIcon_solid.gif) !important
		}
    </style>

	<!-- THIRD PARTY -->
    <script type="text/javascript" src="core/js/libs/extjs/ext-all-debug.js"></script>
    <script type="text/javascript" src="core/js/libs/extjs/ux/CheckColumn.js"></script>
    <script type="text/javascript" src="core/js/libs/d3/d3.v2.js"></script>

	 <!-- Cytoscape.js library for the Graph -->
	<script type="text/javascript" src="core/js/libs/jquery/jquery-2.0.3.js"></script>
	<script type="text/javascript" src="core/js/libs/cytoscape-2.2.12/cytoscape.js"></script>
	<script type="text/javascript" src="core/js/libs/cytoscape-2.2.12/cytoscape.js-cxtmenu.js"></script>
	<script type="text/javascript" src="core/js/libs/cytoscape-2.2.12/arbor.js"></script>

	<script type="text/javascript">
		var canUseD3 = true;
		if (Ext.isIE && Ext.ieVersion < 9) {
//			alert("IE Version is less than 9. Some graphics features will be disabled");
			canUseD3 = false;
		}

		var prepath="rest/";

		var Config = {
		    title:'Graphene',
		    version:'4.1',
			headerUrl: prepath+'accountdetails',
			detailUrl: prepath+'getTransactions',

            transfers_transUrl:prepath+'getEvents',

			entityAdvancedSearch:prepath+'EntitySearch/advancedSearch',
			entityGetByID: prepath+'EntitySearch/getEntityByID/',

			textUrl: prepath+'FreeText/getTransactions',
			monthlyStatisticsUrl: prepath + 'getPairMonthlyStatistics',
			dailyStatisticsUrl: prepath + 'getPairDailyStatistics',
			csvUrl:    prepath+'csv',
			xlsUrl:    prepath+'xls',

			entityGraphUrl:prepath + 'csgraph/',
			// transferGraphUrl:prepath + 'graphml/directed/transfers/',
			//Seems to always be used like Config.entityGraphCSUrl + 'customer/' + custno;
			entityGraphCSUrl:prepath + 'csgraph/',
			transferGraphCSUrl:prepath + 'csgraph/directed/events/',

            // MFM User defined sessions (also used for saving and restoring graphs)
            getUDSessionUrl: prepath + 'UDsession/getSession/',         // takes a session id
            getUDSessionsUrl: prepath + 'UDsession/getSessions',        // no params
            getUDSessionsByDateUrl: prepath + 'UDsession/getSessionsByDate/',    // takes a fromdt/todt
            getUDSessionsByUserIdUrl: prepath + 'UDsession/getSessionsByUserId/',    // takes a userid
            getUDSessionsByNameUrl: prepath + 'UDsession/getSessionsByName/',    // takes a name
            saveUDSessionUrl: prepath + 'UDsession/save',    // POST - takes JSON

			dataSourceUrl:	   prepath+'datasources/getAll',
			restEasy:true,
			canUseD3: canUseD3,
			CXF:false,
			pivotTypes: ["REPORT_ID", "ENTITY"]
		};

		Config.appRoot = "/graphene-${projectName}-web";
		Config.imagesUrl = Config.appRoot + "/images/";
		Config.coreImagesUrl = Config.appRoot + "/core/images/";
		Config.helpIcon = Config.coreImagesUrl + "HelpIcon_solid.gif";
        // Icons for filter animation controls
        Config.PlayReverse = Config.imagesUrl + "PlayReverse_Hover14.png";
        Config.Pause = Config.imagesUrl + "Pause_Hover14.png";
        Config.Play = Config.imagesUrl + "Play_Hover14.png";

</script>


	<!-- Common Graph Tools -->
	<script type="text/javascript" src="core/js/cmp/Graph/common/AbstractGraphPanel.js"></script>
	<script type="text/javascript" src="core/js/cmp/Graph/common/AbstractNodeDisplay.js"></script>
	<script type="text/javascript" src="core/js/cmp/Graph/common/cytoGraphSubs.js"></script>
	<script type="text/javascript" src="core/js/cmp/Graph/common/cytoOverrides.js"></script>
	<script type="text/javascript" src="core/js/cmp/Graph/common/graphSettings.js"></script>
	<script type="text/javascript" src="core/js/cmp/Graph/common/GraphToolbar.js"></script>
	<script type="text/javascript" src="core/js/cmp/Graph/common/graphUtils.js"></script>
	<script type="text/javascript" src="core/js/cmp/Graph/common/NodeActions.js"></script>
	<script type="text/javascript" src="core/js/cmp/Graph/common/NodeEditor.js"></script>
	<script type="text/javascript" src="core/js/cmp/Graph/common/NodeMergeDialog.js"></script>
	<script type="text/javascript" src="core/js/cmp/Graph/common/RadialContextMenu.js"></script>

	<!-- OUR SHARED TOOLS -->
	<script type="text/javascript" src="core/js/cmp/shared/utils.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/formutils.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/dateGroup.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/histogram.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/TLCharts.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/gridFilterSettings.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/filterSettings.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/filterSettings2.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/userDefinedSession.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/exportDialog.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/importDialog.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/ActivityLogger.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/DetailsViewer.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/legendDefs.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/interactiond3.js"></script>
	<script type="text/javascript" src="core/js/cmp/shared/scatterplotd3.js"></script>
	
	<!-- Shared tools overrides -->
	<!-- none -->

	<script type="text/javascript">
//We don't need to know the absolute path or the deployment context.  The prefix is always just rest/

                // DRAPER API
                //Instantiate the Activity Logger
                //var activityLogger = new activityLogger();

                //Register the logger.
                //In this case, we register the logger to look for the logger on
                //port 1337 of the machine "localhost", telling it that this
                //software component is version 3.04 of the software named
                //"graphene" and that the session ID is "AC76999"
                //activityLogger.registerActivityLogger("http://localhost:1337", "graphene", "3.5 Beta", "AC76999");

        function isPivotableType(inType) {
        	// if inType is in Config.pivotTypes, the resulting index ought to be
        	// greater than -1.
        	// return Config.pivotTypes.indexOf(inType) > -1;
        	
        	// for now, allow pivot on any node type in Instagram version
        	return true;
        }
		function makeCSTab()
		{
			makeTab("csType", Ext.create("DARPA.CSFrame", {title:'GLOBAL SEARCH', id:'csFrame'}));

                        // MFM set default search date range
                        var csFrame = getCSFrame().getSearch();
                        if (csFrame) {
                            var fromDate = (new Date(2006,0,1,0,0,0)).getTime();    // default 2006
                            var toDate = (new Date()).getTime();    // Today
                            csFrame.updateCSSearchDates(fromDate, toDate);
                        }
		}
		function makeTransactionTab()
		{
			makeTab("ledgerType", Ext.create("DARPA.TransactionFrame", {title:'LEDGERS', id:'TransactionFrame'})	);
		}
		function makeTransfersTab()
		{
			makeTab("ledgerType", Ext.create("DARPA.TransfersFrame", {title:'TRANSFERS', id:'TransfersFrame'})	);
		}
		function makePBTab()
		{
			makeTab("pbType", Ext.create("DARPA.PBFrame", {title:'ENTITY GRAPH', id:'PBFrame'})	);
		}
		function makeESTab()
		{
			makeTab("esType", Ext.create("DARPA.ESFrame", {title:'ENTITY SEARCH', id:'ESFrame'})	);
		}

        function getCurrentInstitutionName()
        {
            var institutionName;
			
			try {
				if (typeof global_current_datasource == "undefined") throw "error";
				if (typeof global_current_datasource.data == "undefined") throw "error";
				if (typeof global_current_datasource.data.name == "undefined") throw "error";
				
				institutionName = global_current_datasource.data.name;
			} catch(e) {
				console.log("Could not resolve global_current_datasource.data.name.  Setting '${projectName}' as default institution name");
				// FIXME: only temporary implementation; no good if there are multiple "institutions" to select from
				institutionName = "Instagram";
			}
			
			return institutionName;
        }

		function getEDTab(entity, tabToDisplay) // entity details
		{
					if (typeof tabToDisplay == "undefined") tabToDisplay = "3";
					tabToDisplay = parseInt(tabToDisplay);
                    var etab = Ext.getCmp(entity.id);
                    if (etab == null) {
                        var name="";
                        for (var i = 0; i < entity.attributes.length; ++i) {
                            if (entity.attributes[i].family=='Name') {
                                    var n = entity.attributes[i].value;
                                    if (name.length == 0 || n.length < name.length)
                                            name = n;
                                    break;
                            }
                        }

                        var instName = getCurrentInstitutionName();

                        var t = Ext.create("DARPA.EntityTab", {
							institution: instName, 
							title:name, 
							id:entity.id,
							entity:entity, 
							closable:true, 
							componentsToInclude: ["entityGraph"],
							//activeTab: tabToDisplay
						});

                    /*     var t = Ext.create("DARPA.EntityTab", {
                        	institution: instName, 
                        	title:name, id:entity.id, 
                        	entity:entity, 
                        	closable:true, 
                        	componentsToInclude: ["details", "entityGraph"]
                        }); */

                        etab = makeTab("edType", t);
                    }
                    return etab;
		}

		function makeTab(cstype, contents)
		{
			contents.cstype=cstype;
			contents.originalTitle = contents.title;
			Ext.getCmp("tabFrame").add(contents);
			return contents;
		}

	     // handle failures from calls to various Get Services
	     // This will get called on completion of a data store load() call
	     // It checks the response from the server and if not 'ok', displays an alert.
	     // (previously, if there was a server error, the GUI showed no indication of this error - total silence)
	     function QSLoadComplete(context,result) {
	         if (result && result.exception) {
	             var msg = "<br>Search Failed due to Server Error<br>" +
	                 "<br>Details: Code = " + result.error.status + " Text = " + result.error.statusText;
	             setStatus(msg);
	             Ext.Msg.alert(msg);
	         }
	     }

		function setStatus(status)
                {
                	console.log("Attempt to write to legacy status with message " + status);
//                        Ext.getCmp("statusbar").value=status;
                }



                // MFM For IE 9.0.x support when console is not defined
           try {
                 var xx = console.log;
             }
                catch (ee) {
                    //alert("console is not defined");
                    console = {
                        log: function(text) {
                            //alert(text);
                        }
                    };
                }

		Ext.onReady(function(){

		   	Ext.QuickTips.init();
		   	Ext.tip.QuickTipManager.init();
			
		   	// disable the browser from acting on right-click
		    Ext.getBody().on("contextmenu", function() {/* do nothing by default */}, null, {preventDefault: true});

   			Ext.create("Ext.container.Viewport", {
				layout: 'border',
				items: [
					Ext.create("DARPA.EntityGraphPanel", {
						region: 'center',
						title:'Graphene Entity Graph', 
						entityId: "", 
						id: "INSTAGRAM_CUSTOM-EntityGraph",
						institution: getCurrentInstitutionName(),
						resizable: false
					})
				]
   			}); // viewport

            // MFM create legend for all tabs that need them
            // GLegend is global and accessible anywhere in the app
			GLegend = new Legend();
			GLegend.addLegendItems([
			    {groupNames: ["graph_legend"], iconPath: Config.coreImagesUrl+"solid_edge.png", text: "Structured Field"},
				{groupNames: ["graph_legend"], iconPath: Config.coreImagesUrl+"dotted_edge.png", text: "Extracted From Narrative"},
			    {groupNames: ["graph_legend"], iconPath: Config.coreImagesUrl+"dashed_edge.png", text: "User-generated"}
			]);
			// if you only have one legend type in the app, setting the default makes it easier to access without having to
			// remember the key "graph_legend" anywhere else.
			GLegend.setDefaultGroupName("graph_legend");
			
			// create and modify global RadialContextMenu object
			GRadialMenu = new RadialContextMenu({/* config parameters */});

			var parm = window.location.search;
			if (parm && parm.length > 1) {

				parm = parm.substring(1); // ditch the leading '?'
				parms = parm.split("&");
				var schemas = [];
				var entities = [];
				var tabToDisplay = "3";
				var useSaved = true;
				for (var i = 0; i < parms.length; ++i) {
					var p = parms[i];
					var x = p.split("=");
					if (x[0] == 'schema')
						schemas.push(x[1]);
					else if (x[0]=='entity')
						entities.push(x[1]);
					else if (x[0]=="display")
						tabToDisplay = x[1];
					else if (x[0]=="useSaved")
						useSaved = x[1];
				}

				if (entities.length > 0) {
					// for every unique entity in the URL, automatically create a tab for it
					//for (var i in entities) {
						showEntityDetails(entities[0], tabToDisplay, useSaved);
					//}
				}

//				alert("Schema " + schema + " Entity " + entity);
			};

		}); // on ready


		function getCSFrame()
		{
			return Ext.getCmp("csFrame");
		}
		function getESFrame()
		{
			return Ext.getCmp("ESFrame");
		}

		function getTabFrame()
		{
			return Ext.getCmp("tabFrame");
		}
		function getTransactionFrame() {
			return Ext.getCmp("TransactionFrame");
		}
		function getTransfersFrame() {
			return Ext.getCmp("TransfersFrame");
		}

		function getPBFrame() {
			return Ext.getCmp("PBFrame");
		}


                // MFM - Same as getCSFrame
                function getSearchFrame()
                {
                        return getCSFrame();
                }
                // MFM NOT YET
                /*
                function getGraphFrame()
                {
                        return Ext.getCmp("graph");
                }
                */

		function doGlobalSearch(idValue, idType, searchType, caseSensitive)
		{
			var tabList=[
//			"Frame",
//			"TransfersFrame",
//			"PBFrame"
			];
			for (var i = 0; i < tabList.length; ++i) {
				var frame=Ext.getCmp(tabList[i]);
				utils.setBlink(frame, true);
				frame.doSearch(idValue, idType, searchType, caseSensitive, true);
			}

		}

		function showLedger(account, entityId)
		{
			if (!undefined===entityId) {
				getTransactionFrame().doSearch(account, "account", "exactmatch", false, true);
				getTabFrame().setActiveTab(getTransactionFrame());
			}
			else {
				var tab = Ext.getCmp(entityId);
				if (tab != null) { // TODO: Perhaps load entity and create tab
					//tab.loadLedger(account, selectedInst);
					//tab.loadTransfers(account, selectedInst);
//                    tab.loadLedger(account);
					tab.loadTransfers(account);
				}
			}
		}

		function showEntityDetails(id, tabToDisplay, useSaved) {
			//The default will be to use the saved version, because we haven't implemented a Restore from server save yet.
			if (typeof useSaved == "undefined" || useSaved !== false) {
				useSaved = true;
			}

			var entityGraph = Ext.getCmp("INSTAGRAM_CUSTOM-EntityGraph");
			if (entityGraph !== null && typeof entityGraph !== "undefined") {
				entityGraph.load(id, useSaved);
			} else {
				console.error("Entity graph is undefined");
			}
		}

		function showEntityGraph(entity)
		{
			var tab = getEDTab(entity);
		        var gr = tab.getEntityGraph();
		        if (gr) {
		            gr.load(entity.id);
		            if (gr.prevLoadParams) {
		                gr.prevLoadParams.prevNumber = entity.id;
		            }
		            else {
		                gr.prevLoadParams = {prevNumber: entity.id};
		            }
			 }
		}

                // MFM
                // This function is called from the interaction chart within the svg document
                // when the user clicks on the interaction chart.
                // gridId   - Id of the Transfers Grid instance containing data for the chart.
                // x,y      - Mouse on click position within the chart
                function highlightRowForChartPos(gridId, x, y) {
                    // DEBUG
                    //console.log("Parent: highlightRowForChartPos gridid =" + gridId + ", x =" + x + ", y=" + y);

                    var tGrid = Ext.getCmp(gridId);
                    if (tGrid && tGrid.highlightRowForChartPos) {
                        tGrid.highlightRowForChartPos(gridId, x, y);
                    }
                }

                // legacy code; should delete/depreciate
                function updateGridFilterDates(fromDate, toDate) {
                    console.log("Tried to use updateGridFilterDates()");
                }

                // TODO - this needs to return the username or userid from the login page when that is implemented
                function getSessionUserid() {
                    return "unknown";
                }

	</script>
	
	<!-- Might not be using these two anymore -->
    <script type="text/javascript" src="core/CSEARCH/js/CS_Search.js"></script>
	<script type="text/javascript" src="core/CSEARCH/js/CS_Frame.js"></script>

	<script type="text/javascript" src="core/js/cmp/datasets/js/dataSourceLister.js"></script>
	
	<!-- Entity Search common -->
	<script type="text/javascript" src="core/js/cmp/entitysearch/js/Entity_Search.js"></script>
	<script type="text/javascript" src="core/js/cmp/entitysearch/js/Entity_List_Grid.js"></script>
	<script type="text/javascript" src="core/js/cmp/entitysearch/js/Entity_Name_List.js"></script>
	<script type="text/javascript" src="core/js/cmp/entitysearch/js/Entity_Search_Frame.js"></script>

	<!-- TransactionsGrid common -->
    <script type="text/javascript" src="core/js/cmp/TransactionsGrid/js/TXN_HeaderPanel.js"></script>
    <script type="text/javascript" src="core/js/cmp/TransactionsGrid/js/TXN_Menu.js"></script>
    <script type="text/javascript" src="core/js/cmp/TransactionsGrid/js/TXN_Grid.js"></script>
    <script type="text/javascript" src="core/js/cmp/TransactionsGrid/js/TXN_Search.js"></script>
	<script type="text/javascript" src="core/js/cmp/TransactionsGrid/js/TXN_Frame.js"></script>
	
	<!-- TransactionsGrid overrides -->
	<script type="text/javascript" src="core/js/cmp/TransactionsGrid/js/TXN_Ledger.js"></script>
	
	<!-- TransfersGrid common -->
    <script type="text/javascript" src="core/js/cmp/TransfersGrid/js/Walker_timeline.js"></script>
    <script type="text/javascript" src="core/js/cmp/TransfersGrid/js/Walker_timelineButtons.js"></script>
    <script type="text/javascript" src="core/js/cmp/TransfersGrid/js/Walker_timelinePanel.js"></script>
    <script type="text/javascript" src="core/js/cmp/TransfersGrid/js/TFR_HeaderPanel.js"></script>
    <script type="text/javascript" src="core/js/cmp/TransfersGrid/js/TFR_Menu.js"></script>
    <script type="text/javascript" src="core/js/cmp/TransfersGrid/js/TFR_Search.js"></script>
    <script type="text/javascript" src="core/js/cmp/TransfersGrid/js/TFR_Ledger.js"></script>
    <script type="text/javascript" src="core/js/cmp/TransfersGrid/js/TFR_Charts.js"></script>
    <script type="text/javascript" src="core/js/cmp/TransfersGrid/js/TFR_Frame.js"></script>
	
	<!-- TransfersGrid overrides -->
    <script type="text/javascript" src="core/js/cmp/TransfersGrid/js/TFR_Grid.js"></script>

	<!-- EntityGraph common -->
    <script type="text/javascript" src="core/js/cmp/Graph/Entity/EntityGraphPanel.js"></script>
	<script type="text/javascript" src="core/js/cmp/Graph/Entity/EntityNodeDisplay.js"></script>

	<!-- EntityGraph overrides -->
	<!-- none -->

	<!-- TransactionGraph common -->
    <script type="text/javascript" src="core/js/cmp/Graph/Transaction/TransactionGraphPanel.js"></script>
	<script type="text/javascript" src="core/js/cmp/Graph/Transaction/TransactionNodeDisplay.js"></script>

	<!-- TransactionsGraph overrides -->
	<!-- none -->

	<!-- EntityTab common -->
	<script type="text/javascript" src="core/js/cmp/entitytab/js/EntityDetails.js"></script>
	<script type="text/javascript" src="core/js/cmp/entitytab/js/entityTab.js"></script>

</head>


<body>
<!--
<div id="log"></div>
-->
</body>
</html>